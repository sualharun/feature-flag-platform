{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Feature Flag Service Infrastructure",
  "Parameters": {
    "Environment": {
      "Type": "String",
      "Default": "prod",
      "AllowedValues": ["dev", "staging", "prod"],
      "Description": "Environment name"
    },
    "VpcId": {
      "Type": "AWS::EC2::VPC::Id",
      "Description": "VPC ID where resources will be deployed"
    },
    "SubnetIds": {
      "Type": "List<AWS::EC2::Subnet::Id>",
      "Description": "Subnet IDs for the application"
    }
  },
  "Resources": {
    "FeatureFlagTable": {
      "Type": "AWS::DynamoDB::Table",
      "Properties": {
        "TableName": {"Fn::Sub": "feature-flags-${Environment}"},
        "AttributeDefinitions": [
          {
            "AttributeName": "flagName",
            "AttributeType": "S"
          }
        ],
        "KeySchema": [
          {
            "AttributeName": "flagName",
            "KeyType": "HASH"
          }
        ],
        "BillingMode": "PAY_PER_REQUEST",
        "PointInTimeRecoverySpecification": {
          "PointInTimeRecoveryEnabled": true
        },
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          },
          {
            "Key": "Application",
            "Value": "feature-flag-service"
          }
        ]
      }
    },
    "RedisSubnetGroup": {
      "Type": "AWS::ElastiCache::SubnetGroup",
      "Properties": {
        "Description": "Subnet group for Redis cluster",
        "SubnetIds": {"Ref": "SubnetIds"}
      }
    },
    "RedisSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for Redis cluster",
        "VpcId": {"Ref": "VpcId"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 6379,
            "ToPort": 6379,
            "SourceSecurityGroupId": {"Ref": "AppSecurityGroup"}
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "feature-flag-redis-sg-${Environment}"}
          }
        ]
      }
    },
    "RedisCluster": {
      "Type": "AWS::ElastiCache::CacheCluster",
      "Properties": {
        "CacheNodeType": "cache.t3.micro",
        "Engine": "redis",
        "NumCacheNodes": 1,
        "CacheSubnetGroupName": {"Ref": "RedisSubnetGroup"},
        "VpcSecurityGroupIds": [{"Ref": "RedisSecurityGroup"}],
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "AppSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Security group for application",
        "VpcId": {"Ref": "VpcId"},
        "SecurityGroupIngress": [
          {
            "IpProtocol": "tcp",
            "FromPort": 8080,
            "ToPort": 8080,
            "CidrIp": "0.0.0.0/0"
          }
        ],
        "Tags": [
          {
            "Key": "Name",
            "Value": {"Fn::Sub": "feature-flag-app-sg-${Environment}"}
          }
        ]
      }
    },
    "ECSCluster": {
      "Type": "AWS::ECS::Cluster",
      "Properties": {
        "ClusterName": {"Fn::Sub": "feature-flag-cluster-${Environment}"},
        "Tags": [
          {
            "Key": "Environment",
            "Value": {"Ref": "Environment"}
          }
        ]
      }
    },
    "TaskExecutionRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "ManagedPolicyArns": [
          "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
        ]
      }
    },
    "TaskRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [
            {
              "Effect": "Allow",
              "Principal": {
                "Service": "ecs-tasks.amazonaws.com"
              },
              "Action": "sts:AssumeRole"
            }
          ]
        },
        "Policies": [
          {
            "PolicyName": "DynamoDBAccess",
            "PolicyDocument": {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "dynamodb:GetItem",
                    "dynamodb:PutItem",
                    "dynamodb:UpdateItem",
                    "dynamodb:DeleteItem",
                    "dynamodb:Query",
                    "dynamodb:Scan"
                  ],
                  "Resource": {"Fn::GetAtt": ["FeatureFlagTable", "Arn"]}
                }
              ]
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "DynamoDBTableName": {
      "Description": "DynamoDB table name",
      "Value": {"Ref": "FeatureFlagTable"}
    },
    "RedisEndpoint": {
      "Description": "Redis cluster endpoint",
      "Value": {"Fn::GetAtt": ["RedisCluster", "RedisEndpoint.Address"]}
    },
    "ECSClusterName": {
      "Description": "ECS cluster name",
      "Value": {"Ref": "ECSCluster"}
    }
  }
}
